<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reactor Controller</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script crossorigin
        src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prop-types/15.8.1/prop-types.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/recharts/2.12.0/Recharts.min.js"></script>
</head>

<body class="bg-gray-900 text-white font-sans">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        const { LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer } = Recharts;

        const ERR_TC_GAS_INTERNAL = (1 << 0);
        const ERR_TC_FEEDSTOCK = (1 << 1);
        const ERR_TC_VAPORIZER_WALL = (1 << 2);
        const ERR_TC_REACTOR_INT_1 = (1 << 3);
        const ERR_TC_REACTOR_INT_2 = (1 << 4);
        const ERR_TC_REACTOR_EXT_1 = (1 << 5);
        const ERR_TC_REACTOR_EXT_2 = (1 << 6);
        const ERR_P_FEED = (1 << 7);
        const ERR_P_REACTOR = (1 << 8); // Not used yet
        const ERR_MFC_FLOW = (1 << 9);
        const ERR_H2_SENSOR = (1 << 10);

        const STATE_LABELS = {
            0: "STANDBY",
            1: "WARMUP",
            2: "WORKING"
        };

        const STATE_COLORS = {
            0: "text-gray-400 border border-gray-600",
            1: "text-yellow-400 border border-yellow-600",
            2: "text-green-400 border border-green-600"
        };

        function App() {
            const [data, setData] = useState([]);
            const [latest, setLatest] = useState(null);
            const [status, setStatus] = useState("DISCONNECTED");

            useEffect(() => {
                const ws = new WebSocket(`ws://${window.location.host}/ws`);

                ws.onopen = () => setStatus("CONNECTED");
                ws.onclose = () => setStatus("DISCONNECTED");

                ws.onmessage = (event) => {
                    const msg = JSON.parse(event.data);
                    // Add ts for graph
                    msg.ts = new Date().toLocaleTimeString();

                    setLatest(msg);
                    setData(prev => {
                        const next = [...prev, msg];
                        if (next.length > 200) next.shift(); // Increased buffer
                        return next;
                    });
                };

                return () => ws.close();
            }, []);

            const sendState = async (s) => {
                await fetch(`/api/control/state/${s}`, { method: 'POST' });
            }

            const sendSetpoint = async (zone, val, rate) => {
                await fetch(`/api/control/setpoint?zone=${zone}&value=${val}&rate=${rate || 0}`, { method: 'POST' });
            }

            if (!latest) return <div className="p-10 text-center text-gray-400 animate-pulse">Waiting for telemetry...</div>;

            const s = latest.sensors || {};
            const h = latest.heaters || {};
            const sp = latest.sp || {};
            const stateIdx = latest.state || 0;
            const errMask = s.status || 0;

            return (
                <div className="min-h-screen p-4 flex flex-col gap-4">
                    {/* Header */}
                    <header className="bg-gray-800 p-4 rounded-lg shadow-lg flex justify-between items-center border-b border-gray-700">
                        <h1 className="text-2xl font-bold tracking-tight text-blue-400">Reactor Controller</h1>
                        <div className="flex gap-4 items-center">
                            <div className={`text-xl font-bold px-3 py-1 rounded bg-gray-900 ${STATE_COLORS[stateIdx]}`}>
                                {STATE_LABELS[stateIdx] || "UNKNOWN"}
                            </div>
                            <div className="text-sm text-gray-400 font-mono">uptime: {latest.uptime}s</div>
                        </div>
                    </header>

                    {/* Controls */}
                    <div className="flex gap-2 justify-center">
                        <button onClick={() => sendState(0)} className={`px-6 py-2 rounded font-bold transition-all ${stateIdx === 0 ? 'bg-gray-600 ring-2 ring-white' : 'bg-gray-700 text-gray-400 hover:bg-gray-600'}`}>STANDBY</button>
                        <button onClick={() => sendState(1)} className={`px-6 py-2 rounded font-bold transition-all ${stateIdx === 1 ? 'bg-yellow-600 ring-2 ring-white' : 'bg-yellow-800 text-yellow-200 hover:bg-yellow-700'}`}>WARMUP</button>
                        <button onClick={() => sendState(2)} className={`px-6 py-2 rounded font-bold transition-all ${stateIdx === 2 ? 'bg-green-600 ring-2 ring-white' : 'bg-green-800 text-green-200 hover:bg-green-700'}`}>WORKING</button>
                    </div>

                    {/* Process Cards */}
                    <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
                        {/* Zone 1: Gas */}
                        <ZoneCard title="Gas Pre-Heat"
                            temp={s.t_gas} sp={sp.gas} out={h.gas}
                            connected={!(errMask & ERR_TC_GAS_INTERNAL)}
                            onSetSp={(v, r) => sendSetpoint(0, v, r)} />

                        {/* Zone 2: Vaporizer */}
                        <ZoneCard title="Vaporizer"
                            temp={s.t_vap} sp={sp.vap} out={h.vap}
                            connected={!(errMask & ERR_TC_VAPORIZER_WALL)}
                            onSetSp={(v, r) => sendSetpoint(1, v, r)} />

                        {/* Zone 3: Reactor 1 - Check both sensors? Or just Internal? Using Int for primary */}
                        <ZoneCard title="Reactor 1"
                            temp={(s.t_r_i1 + s.t_r_e1) / 2}
                            sub={`I:${s.t_r_i1?.toFixed(1)} E:${s.t_r_e1?.toFixed(1)}`}
                            sp={sp.reac1} out={h.reac1}
                            connected={!(errMask & ERR_TC_REACTOR_INT_1)}
                            onSetSp={(v, r) => sendSetpoint(2, v, r)} />

                        {/* Zone 4: Reactor 2 */}
                        <ZoneCard title="Reactor 2"
                            temp={(s.t_r_i2 + s.t_r_e2) / 2}
                            sub={`I:${s.t_r_i2?.toFixed(1)} E:${s.t_r_e2?.toFixed(1)}`}
                            sp={sp.reac2} out={h.reac2}
                            connected={!(errMask & ERR_TC_REACTOR_INT_2)}
                            onSetSp={(v, r) => sendSetpoint(3, v, r)} />

                        {/* Flow Control */}
                        <FlowCard title="Mass Flow"
                            flow={s.flow} sp={sp.flow}
                            connected={!(errMask & ERR_MFC_FLOW)}
                            onSet={(v) => fetch(`/api/control/flow?value=${v}`, { method: 'POST' })} />

                        {/* Sensors */}
                        <SensorCard title="Pressure" value={s.p_feed} unit="psig" color="text-red-400" border="border-red-500"
                            connected={!(errMask & ERR_P_FEED)} />
                        <SensorCard title="H2 Sensor" value={s.h2} unit="%" color="text-pink-400" border="border-pink-500"
                            connected={!(errMask & ERR_H2_SENSOR)} />
                    </div>

                    {/* Chart */}
                    <div className="flex-1 bg-gray-800 p-4 rounded-lg min-h-[400px] border border-gray-700 shadow-inner">
                        <ResponsiveContainer width="100%" height={400}>
                            <LineChart data={data}>
                                <CartesianGrid strokeDasharray="3 3" stroke="#374151" />
                                <XAxis dataKey="ts" stroke="#9CA3AF" />
                                <YAxis stroke="#9CA3AF" />
                                <Tooltip contentStyle={{ backgroundColor: '#1F2937', border: '1px solid #4B5563', borderRadius: '0.5rem' }} />
                                <Legend />
                                <Line type="monotone" dataKey="sensors.t_gas" stroke="#60A5FA" dot={false} name="Gas" />
                                <Line type="monotone" dataKey="sensors.t_vap" stroke="#FBBF24" dot={false} name="Vap" />
                                <Line type="monotone" dataKey="sensors.t_r_i1" stroke="#34D399" dot={false} name="R1 Int" />
                                <Line type="monotone" dataKey="sensors.t_r_e1" stroke="#059669" dot={false} name="R1 Ext" />
                                <Line type="monotone" dataKey="sensors.p_feed" stroke="#EF4444" dot={false} name="Press (psi)" />
                                <Line type="monotone" dataKey="sensors.h2" stroke="#EC4899" dot={false} name="H2 (%)" />
                            </LineChart>
                        </ResponsiveContainer>
                    </div>
                </div>
            );
        }



        function FlowCard({ title, flow, sp, onSet, connected }) {
            const [val, setVal] = useState(sp);

            // Mask content if disconnected
            const isDisconnected = connected === false;

            return (
                <div className={`bg-gray-800 p-4 rounded-lg border border-purple-500 shadow shadow-purple-900/20 relative overflow-hidden transition-all ${isDisconnected ? 'grayscale opacity-50' : ''}`}>
                    {isDisconnected && (
                        <div className="absolute inset-0 flex items-center justify-center bg-gray-900/80 z-10 backdrop-blur-sm">
                            <span className="text-red-500 font-bold border border-red-500 px-2 py-1 rounded bg-red-900/20 animate-pulse">DISCONNECTED</span>
                        </div>
                    )}

                    <h3 className="text-lg font-semibold text-purple-300 mb-2">{title}</h3>
                    <div className="flex justify-between items-end mb-4">
                        <div>
                            <div className="text-4xl font-mono">{(flow || 0).toFixed(1)}</div>
                            <div className="text-sm text-gray-500">SCCM</div>
                        </div>
                        <div className="text-right">
                            <div className="text-sm text-gray-400">Setpoint</div>
                            <div className="text-xl font-mono text-purple-300">{(sp || 0).toFixed(0)}</div>
                        </div>
                    </div>
                    <div className="flex gap-2">
                        <input type="number"
                            className="bg-gray-900 border border-gray-600 rounded px-2 py-1 w-20 text-white focus:border-purple-500 outline-none"
                            value={val} onChange={(e) => setVal(e.target.value)} disabled={isDisconnected} />
                        <button
                            className="bg-purple-600 px-3 py-1 rounded hover:bg-purple-500 disabled:bg-gray-600"
                            onClick={() => onSet(val)} disabled={isDisconnected}>SET</button>
                    </div>
                </div>
            );
        }

        function SensorCard({ title, value, unit, color, border, connected }) {
            const isDisconnected = connected === false;

            return (
                <div className={`bg-gray-800 p-4 rounded-lg border ${border} shadow opacity-90 relative overflow-hidden ${isDisconnected ? 'grayscale opacity-50' : ''}`}>
                    {isDisconnected && (
                        <div className="absolute inset-0 flex items-center justify-center bg-gray-900/80 z-10 backdrop-blur-sm">
                            <span className="text-red-500 font-bold border border-red-500 px-2 py-1 rounded bg-red-900/20 animate-pulse">DISCONNECTED</span>
                        </div>
                    )}
                    <h3 className={`text-lg font-semibold mb-2 ${color}`}>{title}</h3>
                    <div>
                        <div className="text-4xl font-mono">{(value || 0).toFixed(2)}</div>
                        <div className="text-sm text-gray-500">{unit}</div>
                    </div>
                </div>
            );
        }

        function ZoneCard({ title, temp, sub, sp, out, onSetSp, connected }) {
            const [val, setVal] = useState(sp);
            const [rate, setRate] = useState(0);

            const isDisconnected = connected === false;

            return (
                <div className={`bg-gray-800 p-4 rounded-lg border border-gray-700 relative overflow-hidden ${isDisconnected ? 'grayscale opacity-50' : ''}`}>
                    {isDisconnected && (
                        <div className="absolute inset-0 flex items-center justify-center bg-gray-900/80 z-10 backdrop-blur-sm">
                            <span className="text-red-500 font-bold border border-red-500 px-2 py-1 rounded bg-red-900/20 animate-pulse">DISCONNECTED</span>
                        </div>
                    )}

                    <h3 className="text-lg font-semibold text-gray-300 mb-2">{title}</h3>
                    <div className="flex justify-between items-end mb-4">
                        <div>
                            <div className="text-4xl font-mono">{(temp || 0).toFixed(1)}&deg;C</div>
                            {sub && <div className="text-xs text-gray-400 font-mono mt-1">{sub}</div>}
                            <div className="text-sm text-gray-500 mt-1">Output: <span className={out > 0 ? "text-orange-400" : "text-gray-600"}>{(out / 10).toFixed(0)}%</span></div>
                        </div>
                        <div className="text-right">
                            <div className="text-sm text-gray-400">Setpoint</div>
                            <div className="text-xl font-mono text-blue-300">{(sp || 0).toFixed(0)}&deg;C</div>
                        </div>
                    </div>
                    <div className="flex gap-2 items-center">
                        <div className="flex flex-col">
                            <label className="text-[10px] text-gray-500 uppercase tracking-wider">Target</label>
                            <input type="number"
                                className="bg-gray-900 border border-gray-600 rounded px-2 py-1 w-20 text-white focus:border-blue-500 outline-none"
                                value={val} onChange={(e) => setVal(e.target.value)} disabled={isDisconnected} />
                        </div>
                        <div className="flex flex-col">
                            <label className="text-[10px] text-gray-500 uppercase tracking-wider">Rate/min</label>
                            <input type="number"
                                className="bg-gray-900 border border-gray-600 rounded px-2 py-1 w-16 text-white focus:border-blue-500 outline-none"
                                placeholder="Opt"
                                value={rate} onChange={(e) => setRate(e.target.value)} disabled={isDisconnected} />
                        </div>
                        <button
                            className="bg-blue-600 px-3 py-1 rounded hover:bg-blue-500 h-9 mt-4 text-sm font-bold uppercase tracking-wide disabled:bg-gray-600"
                            onClick={() => onSetSp(val, rate)} disabled={isDisconnected}>SET</button>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>

</html>